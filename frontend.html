<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dots Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body id="body" class="w-screen h-screen bg-amber-100 p-4">
    <canvas id="field" style="image-rendering: pixelated;" width="780" height="640" class="w-[calc(1.25rem*39)] h-[calc(1.25rem*32)] m-auto"></canvas>
  </body>
  <script>
    const rows = 32;
    const columns = 39;

    const body = document.getElementById("body");
    
    /**
     * @type {HTMLCanvasElement}
     */
    const field = document.getElementById("field");
    const canvas = field.getContext("2d");

    canvas.lineWidth = 1;
    
    canvas.beginPath();
    
    for (let r = 1; r < rows; r++) {
      canvas.moveTo(0, r * 20);
      canvas.lineTo(field.offsetWidth, r * 20);
    }
    
    for (let c = 1; c < columns; c++) {
      canvas.moveTo(c * 20, 0);
      canvas.lineTo(c * 20, field.offsetTop + field.offsetHeight);
    }
    
    canvas.stroke();

    const directions = [
      // horizontal
      [-1, 1],
      // diagonal (left to right)
      [-1 - (columns - 1), 1 + (columns - 1)],
      // vertical
      [-(columns - 1), (columns - 1)],
      // diagonal (right to left)
      [1 - (columns - 1), -1 + (columns - 1)]
    ];

    /**
     * @type {boolean[]}
     */
    const occupiedDots = [];

    /**
     * @type {number[][]}
     */
    const unions = [];

    /**
     * @type {number[]}
     */
    const leaders = [];
    
    for (let r = 2; r <= rows; r++) {
      for (let c = 2; c <= columns; c++) {
        const dot = document.createElement("div");
        const dotId = (r - 2) * (columns - 1) + c - 2;
        dot.id = dotId.toString();
        dot.classList.add(
          `left-[${field.offsetLeft + 20 * (c - 1) - 4}px]`,
          `top-[${field.offsetTop + 20 * (r - 1) - 4}px]`,
          "absolute", "w-2", "h-2", "cursor-pointer",
          // "bg-white", "rounded-full", "border", "border-gray-900"
        );

        occupiedDots[dotId] = false;

        dot.onclick = (e) => {
          const dotId = Number(dot.id);

          if (occupiedDots[dotId]) return;

          occupiedDots[dotId] = true;

          dot.classList.add("rounded-full", "bg-blue-700");

          let dotIsInUnion = false;

          for (let direction of directions) {
            const firstOccupiedDot = occupiedDots[dotId + direction[0]]
              ? dotId + direction[0]
              : occupiedDots[dotId + direction[1]]
                ? dotId + direction[1]
                : undefined;

            if (firstOccupiedDot === undefined) continue;
            
            const firstLeader = leaders[firstOccupiedDot];
            unions[firstLeader].push(dotId);
            leaders[dotId] = firstLeader;
            dotIsInUnion = true;

            if (occupiedDots[dotId + direction[0]] && occupiedDots[dotId + direction[1]]) {
              const secondLeader = leaders[dotId + direction[1]];
              if (secondLeader !== firstLeader) {
                unions[firstLeader].push(...unions[secondLeader]);
                unions[secondLeader].forEach(x => leaders[x] = firstLeader);
                unions[secondLeader] = undefined;
              }
            }

            break;
          }

          if (!dotIsInUnion) {
            unions[dotId] = [dotId];
            leaders[dotId] = dotId;
          }

          console.log(unions);
          console.log(leaders);
        }

        body.append(dot);
      }
    }
  </script>
</html>